"use strict";angular.module("config",[]).constant("ENV",{name:"development",apiHost:"104.236.41.26",apiPort:"8080"}),angular.module("riobus",["config","ngAnimate","ngAria","ngCookies","ngResource","ngSanitize","ngTouch","angularMoment"]).run(["$rootScope",function(a){$(".modal-trigger").leanModal(),a.updateInterval=2e4,google.maps.event.addDomListener(window,"load",function(){var b=document.getElementById("map-canvas"),c=new google.maps.LatLng(-22.9083,-43.1964);a.map=new google.maps.Map(b,{center:c,zoom:12,disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.ROADMAP});var d=new google.maps.TrafficLayer;d.setMap(a.map)})}]),angular.module("riobus").controller("MainCtrl",["$scope","$rootScope","$http","$interval","MapMarker","$location","ENV",function(a,b,c,d,e,f,g){var h=this,i=3e3;b.searchLoop=null,b.getEndpoint=function(){return"http://rest.riob.us"},a.search=function(a){a&&(this.busLines=a);var c=this.busLines;c&&(c=c.replace(/\s/g,""),b.searchLoop&&h.cancelLoop(),1===c.split(",").length&&"indefinido"!==c&&h.getItinerary(c),h.doSearch(c,!1),b.searchLoop=d(function(){1===c.split(",").length&&"indefinido"!==c&&h.getItinerary(c),h.doSearch(c,!0)},b.updateInterval))},h.doSearch=function(a,d){e.clear(),c.get(b.getEndpoint()+"/v3/search/"+a).then(function(a){var c=a.data,f=c.length;console.log("Got "+f+" records."),f>0?(h.setMarkers(c),d||e.fitBounds(b.map)):(toast("Nenhum ônibus encontrado para a linha pesquisada.",i),h.cancelLoop())})["catch"](function(a){h.cancelLoop(),404!==a.status?toast("Ocorreu um erro interno. Tente novamente.",i):toast("Nenhum ônibus encontrado para a linha pesquisada.",i)})},h.cancelLoop=function(){d.cancel(b.searchLoop),b.searchLoop=void 0},h.setMarkers=function(a){for(var c=b.map,d=0;d<a.length;d++)e.addMarker(c,a[d])},h.getItinerary=function(a){console.log("Buscando itinerário..."),c.get(b.getEndpoint()+"/v3/itinerary/"+a).then(function(a){var c=a.data,d=e.prepareItinerary(c),f=new google.maps.Polyline({path:d.spotList,geodesic:!0,strokeColor:d.color,strokeOpacity:.4,strokeWeight:5});f.setMap(b.map),e.setItineraryData(f)})["catch"](function(a){})};var j=f.absUrl().split("?")[1];j&&a.search(j)}]),angular.module("riobus").directive("hideKeyboardOnSubmit",function(){return function(a,b){var c=b.find("input");b.bind("submit",function(){c[0].blur()})}}),angular.module("riobus").factory("MapMarker",["moment",function(a){function b(b){return b.sense="indefinido"!==b.line?b.sense.toString().replace(/ *\([^)]*\) */g," "):"Desconhecido",'<div style="line-height:1.35;overflow:hidden;white-space:nowrap;"><h6>'+b.order+" ("+b.line+")</h6>Atualizado em: "+a(b.timeStamp).format("DD/MM/YYYY HH:mm:ss")+"<br/>Velocidade: "+b.speed+" Km/h<br/>Sentido: "+b.sense+"<br/></div>"}function c(a){return a>10?i.bad:a>=5&&10>a?i.average:i.good}function d(){var a;for(a=0;a<k.length;a++)k[a].setMap(null);k=[],l&&(l.setMap(null),l=null),m=new google.maps.LatLngBounds}function e(a){a.fitBounds(m)}function f(d,e){var f=a()-a(e.timeStamp),g=c(f/1e3/60),h=new google.maps.LatLng(e.latitude,e.longitude),i={url:g,scaledSize:new google.maps.Size(36,42)},j=new google.maps.Marker({position:h,map:d,title:e.order+" ("+e.line+")",icon:i});j.info=new google.maps.InfoWindow({content:b(e)}),google.maps.event.addListener(j,"click",function(){j.info.open(d,j)}),m.extend(h),k.push(j)}function g(a){var b={};b.spotList=[],b.description=a.description,b.line=a.line,b.agency=a.agency,b.color=j;for(var c=0;c<a.spots.length;c++){var d=a.spots[c],e=new google.maps.LatLng(d.latitude,d.longitude);b.spotList.push(e)}return b}function h(a){l=a}var i={good:"images/bus_green.png",average:"images/bus_yellow.png",bad:"images/bus_red.png"},j="#0000FF",k=[],l=null,m=new google.maps.LatLngBounds;return{addMarker:f,clear:d,fitBounds:e,prepareItinerary:g,setItineraryData:h}}]);